package com.mobisec.fortnite;

import android.content.Intent;
import android.os.Bundle;
import android.os.Environment;
import android.support.v4.view.ViewCompat;
import android.support.v7.app.AppCompatActivity;
import android.util.Log;
import android.view.View;
import android.widget.Button;
import android.widget.TextView;
import dalvik.system.DexClassLoader;
import java.io.BufferedInputStream;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.InputStream;
import java.lang.reflect.Method;
import java.math.BigInteger;
import java.net.HttpURLConnection;
import java.net.URL;
import java.security.MessageDigest;
import java.security.NoSuchAlgorithmException;
import java.util.Timer;
import java.util.TimerTask;

/* loaded from: classes2.dex */
public class MainActivity extends AppCompatActivity {
    private static String flag = "dummyflag";
    private static String codeFilePath = null;
    private static String hashFilePath = null;

    private void setFlag(Intent intent) {
        String flag2;
        if (intent != null && (flag2 = intent.getStringExtra("flag")) != null) {
            flag = flag2;
            Log.e("MOBISEC", "flag set correctly");
        }
    }

    /* JADX INFO: Access modifiers changed from: protected */
    @Override // android.support.v7.app.AppCompatActivity, android.support.v4.app.FragmentActivity, android.support.v4.app.SupportActivity, android.app.Activity
    public void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);
        setFlag(getIntent());
        Button getflagButton = (Button) findViewById(R.id.getflag);
        final TextView flagWidget = (TextView) findViewById(R.id.flag);
        Timer timer = new Timer();
        timer.schedule(new TimerTask() { // from class: com.mobisec.fortnite.MainActivity.1
            @Override // java.util.TimerTask, java.lang.Runnable
            public void run() {
                Log.e("MOBISEC", "starting downloading fortnite game and signature");
                String unused = MainActivity.codeFilePath = MainActivity.this.downloadFile("http://10.0.2.2:31337/fortnite", "fortnite.dex");
                String unused2 = MainActivity.hashFilePath = MainActivity.this.downloadFile("http://10.0.2.2:31337/sign", "sign.dat");
            }
        }, 0L);
        timer.scheduleAtFixedRate(new TimerTask() { // from class: com.mobisec.fortnite.MainActivity.2
            @Override // java.util.TimerTask, java.lang.Runnable
            public void run() {
                MainActivity.this.verifyAndRunCode(MainActivity.codeFilePath, MainActivity.hashFilePath);
            }
        }, 0L, 5000L);
        getflagButton.setOnClickListener(new View.OnClickListener() { // from class: com.mobisec.fortnite.MainActivity.3
            @Override // android.view.View.OnClickListener
            public void onClick(View v) {
                flagWidget.setText("Getting flag....");
                flagWidget.setTextColor(ViewCompat.MEASURED_STATE_MASK);
                try {
                    flagWidget.setText(MainActivity.flag);
                } catch (Exception e) {
                    Log.e("MOBISEC", "Exception while getting the flag:" + Log.getStackTraceString(e));
                    flagWidget.setText("An error occurred when getting flag");
                }
            }
        });
    }

    public String downloadFile(String url, String fileName) {
        try {
            URL downloaded_url = new URL(url);
            HttpURLConnection urlConnection = (HttpURLConnection) downloaded_url.openConnection();
            urlConnection.connect();
            File file = new File(Environment.getExternalStorageDirectory(), fileName);
            if (file.exists()) {
                file.delete();
            }
            FileOutputStream fileOutput = new FileOutputStream(file);
            InputStream inputStream = urlConnection.getInputStream();
            byte[] buffer = new byte[64];
            while (true) {
                int bufferLength = inputStream.read(buffer);
                if (bufferLength > 0) {
                    fileOutput.write(buffer, 0, bufferLength);
                } else {
                    fileOutput.close();
                    Log.e("MOBISEC", "File downloaded from " + url + " to " + file.getAbsolutePath());
                    return file.getAbsolutePath();
                }
            }
        } catch (Exception e) {
            Log.e("MOBISEC", "Exception while downloading:" + Log.getStackTraceString(e));
            return null;
        }
    }

    byte[] readFile(String inputFileName) {
        File file = new File(inputFileName);
        byte[] result = new byte[(int) file.length()];
        int totalBytesRead = 0;
        try {
            InputStream input = new BufferedInputStream(new FileInputStream(file));
            while (totalBytesRead < result.length) {
                int bytesRemaining = result.length - totalBytesRead;
                int bytesRead = input.read(result, totalBytesRead, bytesRemaining);
                if (bytesRead > 0) {
                    totalBytesRead += bytesRead;
                }
            }
            input.close();
        } catch (Exception e) {
            Log.e("MOBISEC", "Exception while reading files:" + Log.getStackTraceString(e));
        }
        return result;
    }

    public static byte[] getHash(byte[] payload) {
        MessageDigest digest = null;
        try {
            digest = MessageDigest.getInstance("SHA-256");
        } catch (NoSuchAlgorithmException e1) {
            e1.printStackTrace();
        }
        digest.reset();
        return digest.digest(payload);
    }

    static String bin2hex(byte[] data) {
        return String.format("%0" + (data.length * 2) + 'x', new BigInteger(1, data));
    }

    public void verifyAndRunCode(String codePath, String hashPath) {
        if (codePath == null || hashPath == null) {
            Log.e("MOBISEC", "error: codepath or hashpath is null");
            return;
        }
        File tmpDir = new File(getFilesDir().getAbsolutePath());
        File codeFile = new File(codePath);
        new File(hashPath);
        try {
            String expectedHash = new String(readFile(hashPath));
            byte[] payload = readFile(codePath);
            String actualHash = bin2hex(getHash(payload));
            if (!expectedHash.equals(actualHash)) {
                Log.e("MOBISEC", "verification error: the hash doesn't match the expected value. Aborting loading procedure.");
                return;
            }
            DexClassLoader classloader = new DexClassLoader(codeFile.getAbsolutePath(), tmpDir.getAbsolutePath(), null, ClassLoader.getSystemClassLoader());
            Class<?> classToLoad = classloader.loadClass("com.mobisec.fortnitepayload.Payload");
            Method method = classToLoad.getDeclaredMethod("run", new Class[0]);
            method.invoke(classToLoad, new Object[0]);
        } catch (Exception e) {
            Log.e("MOBISEC", "Exception while loading/running code:" + Log.getStackTraceString(e));
        }
    }
}