# Solution

## Description of the problem

Based on a true story.

## Solution


1. I copied the code from the apk to make it a workable apk, and threw it to the system, I got ```com.mobisec.fortnitepayload.Payload: TODO: Implement the real fronite game``` message.
2. Given that I need to call the hidden ```com.mobisec.fortnite``` package to get the flag. So I guess I need to replace ```com.mobisec.fortnitepayload.Payload``` with my own code which is to call the field ```flag``` in  ```com.mobisec.fortnite``` package. Here is my code.
    ```
    public class Payload {
       public static void run() {
           try {
               Log.e("MOBISEC", "here");
               ClassLoader callerClasses = Thread.currentThread().getContextClassLoader();
               Class clazz = callerClasses.loadClass("com.mobisec.fortnite.MainActivity");
               Log.e("MOBISEC", "here2");
               Fields field = new Fields();
               Field flagField = clazz.getDeclaredField("flag");
               flagField.setAccessible(true);
               Object flagValue = flagField.get(field);
               Log.e("MOBISEC", "done");
               Log.e("MOBISEC", "flag " + flagValue);
           } catch (ClassNotFoundException e) {
               Log.e("MOBISEC", String.valueOf(e));
               throw new RuntimeException(e);
           } catch (IllegalAccessException e2) {
               Log.e("MOBISEC", String.valueOf(e2));
               throw new RuntimeException(e2);
           } catch (NoSuchFieldException e3) {
               Log.e("MOBISEC", String.valueOf(e3));
               throw new RuntimeException(e3);
           } catch (Exception e4) {
               Log.e("MOBISEC", String.valueOf(e4));
               throw new RuntimeException(e4);
           }
        }
    }

    public class Fields {
        private static String flag;
    }
    ```

To get the ```com.mobisec.fortnite```, I used ``` ClassLoader callerClasses = Thread.currentThread().getContextClassLoader()``` to load the class and then choose the ```MainActivity``` Class. To store the flag, I define a new Class Fields, which has one field ```flag```, to catch the filed of the ```MainActivity``` Class, after I set ```accessible``` to be true.
3. And then I built it to an apk, and changed the file externsion to ```.zip```. After I unzip it, I got the dex file, which will be renamed to ```fortnite.dex``` and used to replace the one I got in ```http://10.0.2.2:31337/fortnite```.
4. Since the code of ```fortnite.dex``` is changed, the ```sign.dat``` needs to be changed. To do that, I wrote a code to get the new signature.
   ```
   import java.io.BufferedInputStream;
   import java.io.File;
   import java.io.FileInputStream;
   import java.io.FileNotFoundException;
   import java.io.FileOutputStream;
   import java.io.FileWriter;
   import java.io.IOException;
   import java.io.InputStream;
   import java.math.BigInteger;
   import java.security.MessageDigest;
   import java.security.NoSuchAlgorithmException;

   public class hash {    
       static byte[] readFile(String inputFileName) {
           File file = new File(inputFileName);
           byte[] result = new byte[(int) file.length()];
           int totalBytesRead = 0;
           try {
               InputStream input = new BufferedInputStream(new FileInputStream(file));
               while (totalBytesRead < result.length) {
                   int bytesRemaining = result.length - totalBytesRead;
                   int bytesRead = input.read(result, totalBytesRead, bytesRemaining);
                   if (bytesRead > 0) {
                       totalBytesRead += bytesRead;
                   }
               }
               input.close();
           } catch (Exception e) {
               System.out.println(e);
           }
           return result;
       }

       public static byte[] getHash(byte[] payload) {
           MessageDigest digest = null;
           try {
               digest = MessageDigest.getInstance("SHA-256");
           } catch (NoSuchAlgorithmException e1) {
               e1.printStackTrace();
           }
           digest.reset();
           return digest.digest(payload);
       }

       static String bin2hex(byte[] data) {
           return String.format("%0" + (data.length * 2) + 'x', new BigInteger(1, data));
       }
               
       public static void main(String[] args) throws IOException{
           byte[] payload = readFile("fortnite.dex");
           String actualHash = bin2hex(getHash(payload));
           System.out.println(actualHash);
           File myObj = new File("sign.dat");
           if (myObj.createNewFile()) {
               System.out.println("File created: " + myObj.getName());
           } else {
               System.out.println("File already exists.");
           }
           FileWriter myWriter = new FileWriter("sign.dat");
           myWriter.write(actualHash);
           myWriter.close();
           System.out.println("Successfully wrote to the file.");
           test();

       }

       public static void test() throws FileNotFoundException {
           InputStream in = new FileInputStream("test2.txt");
           FileOutputStream out = null;
           try {
               out = new FileOutputStream("test.txt");
           } catch (FileNotFoundException e) {
               throw new RuntimeException(e);
           }
           byte[] buff = new byte[1024];
           int read = 0;

           try {
               while (true) {
                   try {
                       if (!((read = in.read(buff)) > 0)) break;
                   } catch (IOException e) {
                       throw new RuntimeException(e);
                   }
                   try {
                       out.write(buff, 0, read);
                   } catch (IOException e) {
                       throw new RuntimeException(e);
                   }
               }
           } finally {
               try {
                   in.close();
               } catch (IOException e) {
                   throw new RuntimeException(e);
               }
               try {
                   out.close();
               } catch (IOException e) {
                   throw new RuntimeException(e);
               }
           }
       }
   }
   ```
5. After I put these two files under ```/res/raw``` and replaced it in the sdcard storage, I run the application and got the flag.

## Optional Feedback

I think it needs more introduction for the background, and maybe giving some hints will be better. I am really confused about what is to meaning of the ```TODO```.